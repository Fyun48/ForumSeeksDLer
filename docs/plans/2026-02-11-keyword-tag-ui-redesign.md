# 關鍵字標籤式 UI 重新設計

## 日期: 2026-02-11

## 概述

將三組關鍵字（標題篩選、手動網頁下載、SMG）統一改為標籤式 (Tag Chips) 輸入，輸入一個基礎關鍵字自動展開為 4 種匹配變體。三組關鍵字全部整合到「版區群組」分頁，從進階設定分頁移除特殊下載關鍵字。

## 關鍵字展開邏輯

使用者輸入一個基礎關鍵字，系統自動產生 4 種變體用於匹配：

```
輸入: transfer.it
展開: @transfer.it, @ transfer.it, transfer.it@, transfer.it @
```

- Config 中只儲存基礎關鍵字列表
- 執行時動態展開，用於帖子標題比對
- 匹配邏輯不變：`keyword.lower() in title.lower()` 子字串比對

### 設定格式變更

```yaml
# 舊格式
title_filters:
  - '@mg'
  - '@ mg'
  - 'mg@'
  - 'mg @'

# 新格式
title_filters:
  - 'mg'
  - 'mega'
  - 'gofile'
```

## UI 設計

### 位置

三組關鍵字區塊垂直排列在「版區群組」分頁中。

### 佈局

```
┌─ 標題篩選關鍵字 (JDownloader 下載) ─────────────────┐
│ [mg] × [mega] × [gofile] × [send] × [mf] ×         │
│ ┌──────────────────────┐ [新增]                      │
│ │ 輸入關鍵字後按 Enter  │                             │
│ └──────────────────────┘                             │
└──────────────────────────────────────────────────────┘

┌─ 手動網頁下載篩選關鍵字 ────────────────────────────┐
│ [gd] × [transfer] ×                                 │
│ ┌──────────────────────┐ [新增]                      │
│ └──────────────────────┘                             │
└──────────────────────────────────────────────────────┘

┌─ SMG 篩選關鍵字 ────────────────────────────────────┐
│ [smg] ×                                             │
│ ┌──────────────────────┐ [新增]                      │
│ └──────────────────────┘                             │
└──────────────────────────────────────────────────────┘
```

### 互動方式

- 輸入框打字後按 Enter 或點「新增」按鈕 → 關鍵字變成標籤
- 每個標籤右側有 × 可點擊刪除
- 重複的關鍵字自動忽略不新增

## 程式碼改動範圍

### 需要修改的檔案

1. **`src/gui/main_window.py`**
   - 新增 `TagWidget` 元件（標籤式輸入元件，可複用於三組）
   - 改寫版區群組分頁，加入三組標籤輸入區塊
   - 移除進階設定分頁的「特殊下載關鍵字」GroupBox
   - 移除舊的 QListWidget 標題篩選 UI 和相關方法（`_add_filter`, `_remove_filter`）
   - 更新 `_load_config` 和 `_save_config` 讀寫基礎關鍵字

2. **`src/main.py`**
   - 新增 `expand_keywords(base_list)` 函數，將基礎關鍵字展開為 4 種變體
   - 修改初始化邏輯，讀取基礎關鍵字後展開再傳給 `PostParser`
   - 修改 `_get_download_type` 使用展開後的關鍵字比對

3. **`src/gui/search_download_worker.py`**
   - 同步修改，使用展開後的關鍵字

4. **`src/utils/profile_manager.py`**
   - 更新 `_create_default_config()` 改存基礎關鍵字

5. **`config/config.yaml`**
   - 更新預設格式為基礎關鍵字

### 不需要改動

- 資料庫結構、`PostParser`、`LinkExtractor` — 只接收展開後的關鍵字，邏輯不變

## 遷移策略

### 自動轉換

讀取設定時偵測舊格式（關鍵字包含 `@` 符號），自動反推基礎關鍵字：

```
舊: ['@mg', '@ mg', 'mg@', 'mg @', '@mega', 'mega@', '@ mega', 'mega @']
     ↓ 自動轉換
新: ['mg', 'mega']
```

### 轉換邏輯

1. 讀取設定時偵測是否為舊格式（關鍵字包含 `@` 符號）
2. 去除 `@` 和首尾空格，取唯一值
3. 首次儲存後即為新格式

### 邊界情況

- 不符合 4 種變體模式的舊關鍵字（如 `MG@JD`）直接丟棄
- 使用者需在新 UI 中重新設定想要的基礎關鍵字
